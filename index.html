<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI èµ„äº§ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .nav-tab.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; background: #eff6ff; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

  <div class="container mx-auto p-4 max-w-4xl">
    <header class="bg-white rounded-2xl shadow-sm p-6 mb-6 flex justify-between items-center border-b-4 border-blue-500">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">AI èµ„äº§é¡¾é—® Pro</h1>
        <p class="text-xs text-slate-500">é›†æˆç°é‡‘æµã€å®ç‰©é‡‘ã€é©¬ç¾è‚¡ä¸ AI åˆ†æ</p>
      </div>
      <div id="conn-status" class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-400">æœªè¿æ¥ API</div>
    </header>

    <nav class="grid grid-cols-5 bg-white shadow-sm p-1 rounded-xl sticky top-4 z-50 mb-6 border border-slate-200">
        <button onclick="showTab('overview')" id="btn-overview" class="nav-tab active py-3 text-xs font-bold rounded-lg transition-all">æ¦‚è§ˆ</button>
        <button onclick="showTab('stocks')" id="btn-stocks" class="nav-tab py-3 text-xs font-bold rounded-lg transition-all text-slate-500">è‚¡ç¥¨</button>
        <button onclick="showTab('gold')" id="btn-gold" class="nav-tab py-3 text-xs font-bold rounded-lg transition-all text-slate-500">é»„é‡‘</button>
        <button onclick="showTab('cash')" id="btn-cash" class="nav-tab py-3 text-xs font-bold rounded-lg transition-all text-slate-500">ç°é‡‘æµ</button>
        <button onclick="showTab('ai')" id="btn-ai" class="nav-tab py-3 text-xs font-bold rounded-lg transition-all text-blue-600">AIè¯†åˆ«</button>
    </nav>

    <section id="tab-overview" class="tab-content active space-y-4">
      <div class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg">
        <p class="text-xs opacity-80 uppercase font-bold mb-1">AI è´¢åŠ¡æ€»é¡¾é—®å»ºè®®</p>
        <div id="ai-advice-box" class="text-sm italic leading-relaxed">
          ç‚¹å‡»ä¸‹æ–¹çš„ AI è¯†åˆ«é¡µä¸Šä¼ è´¦å•ï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆå…¨ç›˜èµ„äº§é…ç½®å»ºè®®...
        </div>
        <button onclick="getAiAdvice()" class="mt-4 text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full border border-white/30 transition-all">åˆ·æ–° AI å»ºè®®</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-6 rounded-2xl text-white shadow-md">
          <p class="text-blue-100 text-xs uppercase font-bold">æ€»èµ„äº§ä¼°å€¼ (MYR)</p>
          <h2 id="total-val" class="text-3xl font-black mt-1">RM 0.00</h2>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
          <p class="text-slate-400 text-xs uppercase font-bold">ç°é‡‘ä½™é¢ (Cash)</p>
          <h2 id="cash-balance-display" class="text-3xl font-black text-slate-700 mt-1">RM 0.00</h2>
        </div>
      </div>

      <div class="bg-white p-4 rounded-2xl shadow-sm h-80 border border-slate-100">
        <canvas id="chart-main"></canvas>
      </div>
    </section>

    <section id="tab-stocks" class="tab-content space-y-4">
      <div class="bg-white p-4 rounded-2xl shadow-sm border-2 border-dashed border-slate-200">
        <h4 class="text-sm font-bold mb-3 text-slate-600">âœï¸ æ‰‹åŠ¨å½•å…¥æŒä»“</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <input type="text" id="add-stock-symbol" placeholder="ä»£ç (å¦‚:TSLA)" class="p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
          <input type="number" id="add-stock-shares" placeholder="è‚¡æ•°" class="p-2 border rounded-lg text-sm">
          <input type="number" id="add-stock-price" placeholder="æˆæœ¬ä»·" class="p-2 border rounded-lg text-sm">
          <select id="add-stock-market" class="p-2 border rounded-lg text-sm bg-slate-50">
            <option value="my">é©¬è‚¡(RM)</option>
            <option value="us">ç¾è‚¡($)</option>
          </select>
          <button onclick="manualAddStock()" class="md:col-span-4 bg-slate-800 text-white py-2.5 rounded-lg font-bold text-sm hover:bg-slate-700">ç¡®è®¤æ·»åŠ æŒä»“</button>
        </div>
      </div>
      <div id="stock-container" class="space-y-4"></div>
    </section>

    <section id="tab-gold" class="tab-content space-y-4">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <h3 class="font-bold text-yellow-700 mb-4 flex items-center gap-2">ğŸ’° å®ç‰©é»„é‡‘æŒä»“ (æ‰‹å†™å½•å…¥)</h3>
        <div class="space-y-4">
          <div class="flex items-center gap-4 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
            <div class="flex-1">
              <p class="text-xs font-bold text-yellow-800">999 çº¯é‡‘ (å…‹/g)</p>
              <input type="number" id="g999-weight" oninput="updateGoldValues()" class="w-full bg-transparent text-2xl font-black outline-none text-yellow-900" value="0">
            </div>
            <div class="text-right">
              <p class="text-[10px] text-slate-400 uppercase">å½“å‰ä¼°å€¼</p>
              <p id="g999-val" class="font-bold text-yellow-700">RM 0.00</p>
            </div>
          </div>
          <div class="flex items-center gap-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
            <div class="flex-1">
              <p class="text-xs font-bold text-orange-800">916 é¥°é‡‘ (å…‹/g)</p>
              <input type="number" id="g916-weight" oninput="updateGoldValues()" class="w-full bg-transparent text-2xl font-black outline-none text-orange-900" value="0">
            </div>
            <div class="text-right">
              <p class="text-[10px] text-slate-400 uppercase">å½“å‰ä¼°å€¼</p>
              <p id="g916-val" class="font-bold text-orange-700">RM 0.00</p>
            </div>
          </div>
        </div>
        <p class="text-[10px] text-slate-400 mt-6 text-center italic">* é‡‘ä»·æ•°æ®ç”± BuySilverMalaysia å®æ—¶æä¾› (93% å›æ”¶å‚è€ƒä»·)</p>
      </div>
    </section>

    <section id="tab-cash" class="tab-content space-y-4">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ’¸ ç°é‡‘å¾€æ¥æµæ°´</h3>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <input id="cf-desc" placeholder="æµæ°´é¡¹ç›® (å¦‚:è–ªæ°´)" class="border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500">
                <input id="cf-amt" type="number" placeholder="é‡‘é¢ (+/-)" class="border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="addCashFlow()" class="col-span-2 bg-green-600 text-white py-2.5 rounded-lg font-bold hover:bg-green-700 transition-colors">æ·»åŠ ç°é‡‘è®°å½•</button>
            </div>
            <div id="cash-list" class="divide-y border-t mt-4"></div>
        </div>
    </section>

    <section id="tab-ai" class="tab-content space-y-4">
      <div class="bg-gradient-to-br from-purple-600 to-indigo-700 p-6 rounded-2xl text-white shadow-lg">
        <h3 class="text-xl font-bold mb-2 flex items-center gap-2">ğŸ“¸ AI æ™ºèƒ½è§£æè´¦å•</h3>
        <p class="text-indigo-100 text-xs mb-4">ä¸Šä¼  PDF ç”µå­è´¦å•ã€ç¾è‚¡ç»“å•æˆ–çº¸è´¨è´¦å•ç…§ç‰‡ã€‚AI ä¼šè‡ªåŠ¨å åŠ åˆ°å½“å‰èµ„äº§ä¸­ã€‚</p>
        <div class="bg-white/10 p-4 rounded-xl border border-white/20 mb-4">
            <input type="file" id="ai-file" accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" class="block w-full text-xs text-slate-200 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-white file:text-purple-700 hover:file:bg-purple-50">
        </div>
        <button id="ai-btn" onclick="runAiParser()" class="w-full py-3 bg-white text-purple-700 font-bold rounded-xl shadow-lg hover:bg-indigo-50 active:scale-[0.98] transition-all">å¼€å§‹ AI æ·±åº¦è§£æå¹¶åŒæ­¥</button>
      </div>

      <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
        <h4 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">åç«¯ API èŠ‚ç‚¹é…ç½®</h4>
        <input type="text" id="api-url" class="w-full p-3 text-sm border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://your-app.onrender.com">
        <button onclick="initConnection()" class="w-full mt-2 py-2.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-200 transition-all">ä¿å­˜é…ç½®å¹¶è¿æ¥</button>
        <button onclick="clearAllData()" class="w-full mt-2 py-2 bg-red-50 text-red-400 rounded-lg text-[10px]">å±é™©ï¼šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰æ•°æ®</button>
      </div>
    </section>
  </div>

  <script>
    // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
    let db = {
      portfolio: {
        stocks_my: [], 
        stocks_us: [],
        cash_balance: 0,
        gold_999_w: 0,
        gold_916_w: 0
      },
      cashflow: [], 
      market: {
        g999: 0, g916: 0, 
        prices: {}, 
        rate: 4.72 
      }
    };

    let charts = {};

    // --- åˆå§‹åŒ–åŠ è½½ ---
    window.onload = () => {
      const saved = localStorage.getItem('ai_assets_db');
      if (saved) db = JSON.parse(saved);
      
      const savedUrl = localStorage.getItem('apiUrl');
      if (savedUrl) document.getElementById('api-url').value = savedUrl;

      // æ¢å¤è¾“å…¥æ¡†å€¼
      document.getElementById('g999-weight').value = db.portfolio.gold_999_w;
      document.getElementById('g916-weight').value = db.portfolio.gold_916_w;

      initConnection();
      refreshAll();
    };

    function save() {
      localStorage.setItem('ai_assets_db', JSON.stringify(db));
    }

    function clearAllData() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- å¯¼èˆªé€»è¾‘ ---
    function showTab(id) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(el => {
        el.classList.remove('active');
        el.classList.add('text-slate-500');
      });
      document.getElementById('tab-' + (id === 'cash' ? 'cash' : id)).classList.add('active');
      document.getElementById('btn-' + id).classList.add('active');
      document.getElementById('btn-' + id).classList.remove('text-slate-500');
      if(id === 'overview') refreshCharts();
    }

    // --- API & AI é€»è¾‘ ---
    async function initConnection() {
      const url = document.getElementById('api-url').value;
      if (!url) return;
      localStorage.setItem('apiUrl', url);
      
      try {
        const res = await fetch(`${url}/api/gold-price`);
        const data = await res.json();
        if (data.success) {
          db.market.g999 = data.data.gold_999;
          db.market.g916 = data.data.gold_916_buyback; // ä½¿ç”¨åç«¯è¿”å›çš„ 916 å›æ”¶ä»·
          document.getElementById('conn-status').innerText = "API å·²è¿æ¥";
          document.getElementById('conn-status').className = "text-xs px-3 py-1 rounded-full bg-green-100 text-green-600 font-bold";
          refreshAll();
          fetchStockPrices();
        }
      } catch (e) { 
          console.error("è¿æ¥å¤±è´¥"); 
          document.getElementById('conn-status').innerText = "è¿æ¥å¤±è´¥";
          document.getElementById('conn-status').className = "text-xs px-3 py-1 rounded-full bg-red-100 text-red-500 font-bold";
      }
    }

    async function runAiParser() {
        const fileInput = document.getElementById('ai-file');
        const btn = document.getElementById('ai-btn');
        const apiUrl = localStorage.getItem('apiUrl');

        if(!fileInput.files[0]) return alert("è¯·å…ˆé€‰ä¸ªå›¾æˆ–è€…PDFå†ç‚¹æˆ‘");
        if(!apiUrl) return alert("è¯·å…ˆåœ¨ä¸‹æ–¹é…ç½® API èŠ‚ç‚¹åœ°å€");

        btn.innerText = "ğŸš€ AI æ­£åœ¨æ·±åº¦è¯»å–è§£æ...";
        btn.disabled = true;

        const fd = new FormData();
        fd.append('file', fileInput.files[0]);

        try {
            const res = await fetch(`${apiUrl}/api/parse-statement-ai`, {
                method: 'POST',
                body: fd
            });
            const result = await res.json();
            
            if(result.success) {
                // æ•°æ®åˆå¹¶ç­–ç•¥ï¼šå°†è¯†åˆ«å‡ºçš„æ•°æ®è¿½åŠ åˆ°ç°æœ‰æ•°æ®åº“
                const newData = result.data;
                if(newData.stocks_my) db.portfolio.stocks_my = [...db.portfolio.stocks_my, ...newData.stocks_my];
                if(newData.stocks_us) db.portfolio.stocks_us = [...db.portfolio.stocks_us, ...newData.stocks_us];
                if(newData.cash_balance) db.portfolio.cash_balance += newData.cash_balance;
                
                save();
                refreshAll();
                alert("AI è¯†åˆ«æˆåŠŸï¼æ•°æ®å·²å®æ—¶åŒæ­¥å¹¶å åŠ ã€‚");
                
                // è‡ªåŠ¨è§¦å‘ AI è´¢åŠ¡å»ºè®®
                getAiAdvice();
            } else {
                alert("AI è¯†åˆ«å¤±è´¥: " + result.error);
            }
        } catch(e) { 
            alert("ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ API åœ°å€æ˜¯å¦æ­£ç¡®æˆ–æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ã€‚"); 
        } finally { 
            btn.innerText = "å¼€å§‹ AI æ·±åº¦è§£æå¹¶åŒæ­¥"; 
            btn.disabled = false; 
        }
    }

    async function getAiAdvice() {
        const adviceBox = document.getElementById('ai-advice-box');
        const apiUrl = localStorage.getItem('apiUrl');
        
        adviceBox.innerText = "æ­£åœ¨åˆ†æå…¨ç›˜èµ„äº§é…ç½®ã€å¸‚åœºæ³¢åŠ¨ä¸ç°é‡‘æµå¥åº·åº¦...";
        
        try {
            // è¿™é‡Œå‡è®¾åç«¯æœ‰ä¸€ä¸ª /api/ai-advisor æ¥å£ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ç”¨æç¤ºè¯é€»è¾‘æ›¿ä»£
            const res = await fetch(`${apiUrl}/api/ai-advisor`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(db)
            });
            const data = await res.json();
            adviceBox.innerText = data.advice || "æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆå»ºè®®ã€‚";
        } catch(e) {
            // å‰ç«¯å¤‡ç”¨æ¨¡æ‹Ÿå»ºè®®
            setTimeout(() => {
                const total = parseFloat(document.getElementById('total-val').innerText.replace('RM ', '').replace(/,/g, ''));
                adviceBox.innerText = `[æœ¬åœ°å»ºè®®] èµ„äº§å·²æ›´æ–°ã€‚ç›®å‰æ‚¨çš„æ€»èµ„äº§ä¸º RM${total.toFixed(2)}ã€‚å»ºè®®ç»§ç»­ä¿æŒåˆ†æ•£æŠ•èµ„ï¼Œå¹¶å…³æ³¨é»„é‡‘çš„å›è°ƒä¹°å…¥æœºä¼šã€‚`;
            }, 1500);
        }
    }

    async function fetchStockPrices() {
      const url = localStorage.getItem('apiUrl');
      const symbols = [...db.portfolio.stocks_my, ...db.portfolio.stocks_us].map(s => s.symbol);
      if(symbols.length === 0) return;

      try {
        const res = await fetch(`${url}/api/stock-prices`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ symbols })
        });
        const data = await res.json();
        if (data.success) {
          db.market.prices = data.prices;
          refreshAll();
        }
      } catch (e) { console.log("è‚¡ä»·æ›´æ–°è·³è¿‡"); }
    }

    // --- ä¸šåŠ¡é€»è¾‘ ---
    function manualAddStock() {
      const s = document.getElementById('add-stock-symbol').value.toUpperCase();
      const n = parseFloat(document.getElementById('add-stock-shares').value);
      const p = parseFloat(document.getElementById('add-stock-price').value);
      const m = document.getElementById('add-stock-market').value;

      if(!s || isNaN(n)) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");
      const target = m === 'my' ? db.portfolio.stocks_my : db.portfolio.stocks_us;
      target.push({ symbol: s, shares: n, avgPrice: p || 0 });
      save();
      refreshAll();
      document.getElementById('add-stock-symbol').value = '';
      document.getElementById('add-stock-shares').value = '';
    }

    function addCashFlow() {
        const desc = document.getElementById('cf-desc').value;
        const amt = parseFloat(document.getElementById('cf-amt').value);
        if(!desc || isNaN(amt)) return alert("è¯·è¾“å…¥æµæ°´é¡¹ç›®å’Œé‡‘é¢");
        
        db.cashflow.unshift({desc, amount: amt, date: new Date().toLocaleDateString()});
        db.portfolio.cash_balance += amt;
        save();
        refreshAll();
        
        document.getElementById('cf-desc').value = '';
        document.getElementById('cf-amt').value = '';
    }

    function updateGoldValues() {
      db.portfolio.gold_999_w = parseFloat(document.getElementById('g999-weight').value) || 0;
      db.portfolio.gold_916_w = parseFloat(document.getElementById('g916-weight').value) || 0;
      save();
      refreshAll();
    }

    // --- é¡µé¢æ¸²æŸ“ ---
    function refreshAll() {
      // 1. é»„é‡‘è®¡ç®—
      const v999 = db.portfolio.gold_999_w * db.market.g999;
      const v916 = db.portfolio.gold_916_w * db.market.g916;
      document.getElementById('g999-val').innerText = `RM ${v999.toFixed(2)}`;
      document.getElementById('g916-val').innerText = `RM ${v916.toFixed(2)}`;

      // 2. ç°é‡‘åˆ—è¡¨æ¸²æŸ“
      const cashListEl = document.getElementById('cash-list');
      cashListEl.innerHTML = db.cashflow.map(i => `
        <div class="flex justify-between py-3 text-sm items-center">
          <span class="text-slate-500 text-xs">${i.date} <span class="text-slate-800 font-medium ml-2">${i.desc}</span></span>
          <span class="font-bold ${i.amount >= 0 ? 'text-green-600' : 'text-red-600'}">${i.amount >= 0 ? '+' : ''}${i.amount.toFixed(2)}</span>
        </div>
      `).join('') || '<p class="text-xs text-slate-400 py-6 text-center">å°šæ— æµæ°´è®°å½•</p>';

      // 3. è‚¡ç¥¨æ¸²æŸ“
      renderStockSection();

      // 4. æ€»èµ„äº§è®¡ç®—é€»è¾‘
      let stockValueMYR = 0;
      db.portfolio.stocks_my.forEach(s => {
        const cur = db.market.prices[s.symbol] || s.avgPrice;
        stockValueMYR += (cur * s.shares);
      });
      db.portfolio.stocks_us.forEach(s => {
        const cur = db.market.prices[s.symbol] || s.avgPrice;
        stockValueMYR += (cur * s.shares * db.market.rate);
      });

      const totalValue = stockValueMYR + v999 + v916 + db.portfolio.cash_balance;
      
      document.getElementById('total-val').innerText = `RM ${totalValue.toLocaleString(undefined, {minimumFractionDigits:2})}`;
      document.getElementById('cash-balance-display').innerText = `RM ${db.portfolio.cash_balance.toLocaleString(undefined, {minimumFractionDigits:2})}`;

      refreshCharts(stockValueMYR, v999 + v916, db.portfolio.cash_balance);
    }

    function renderStockSection() {
      const container = document.getElementById('stock-container');
      container.innerHTML = `
        <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
          <h4 class="font-bold text-blue-600 border-b pb-2 mb-3 flex items-center gap-2">ğŸ‡²ğŸ‡¾ é©¬è‚¡æŒä»“</h4>
          ${db.portfolio.stocks_my.map(s => renderItem(s, 'RM')).join('') || '<p class="text-xs text-slate-400">æš‚æ— é©¬è‚¡æ•°æ®</p>'}
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
          <h4 class="font-bold text-indigo-600 border-b pb-2 mb-3 flex items-center gap-2">ğŸ‡ºğŸ‡¸ ç¾è‚¡æŒä»“</h4>
          ${db.portfolio.stocks_us.map(s => renderItem(s, '$')).join('') || '<p class="text-xs text-slate-400">æš‚æ— ç¾è‚¡æ•°æ®</p>'}
        </div>
      `;
    }

    function renderItem(s, cur) {
      const marketPrice = db.market.prices[s.symbol] || s.avgPrice;
      const profit = (marketPrice - s.avgPrice) * s.shares;
      return `
        <div class="flex justify-between items-center py-2.5 border-b border-slate-50 last:border-0">
          <div>
            <p class="font-bold text-slate-800">${s.symbol}</p>
            <p class="text-[10px] text-slate-400 uppercase">${s.shares} è‚¡ @ æˆæœ¬ ${cur}${s.avgPrice.toFixed(2)}</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-sm text-slate-700">${cur}${(marketPrice * s.shares).toFixed(2)}</p>
            <p class="text-[10px] font-bold ${profit >= 0 ? 'text-green-500' : 'text-red-500'}">${profit >= 0 ? '+' : ''}${profit.toFixed(2)}</p>
          </div>
        </div>
      `;
    }

    function refreshCharts(sVal, gVal, cVal) {
      const ctx = document.getElementById('chart-main');
      if (charts.main) charts.main.destroy();
      
      const hasData = (sVal + gVal + cVal) > 0;
      
      charts.main = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['è‚¡ç¥¨èµ„äº§', 'å®ç‰©é»„é‡‘', 'ç°é‡‘ä½™é¢'],
          datasets: [{
            data: hasData ? [sVal, gVal, cVal] : [0, 0, 1],
            backgroundColor: hasData ? ['#3b82f6', '#fbbf24', '#10b981'] : ['#f1f5f9', '#f1f5f9', '#f1f5f9'],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: { 
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            }
        }
      });
    }
  </script>
</body>
</html>
