<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’° Smart Asset Management System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    h1 {
      font-size: 28px;
      color: #1a202c;
      margin-bottom: 8px;
    }
    
    h2 {
      font-size: 20px;
      color: #2d3748;
    }
    
    .subtitle {
      color: #718096;
      font-size: 14px;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    button, .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #4299e1;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #3182ce;
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover:not(:disabled) {
      background: #38a169;
    }
    
    .btn-warning {
      background: #ed8936;
      color: white;
    }
    
    .btn-warning:hover:not(:disabled) {
      background: #dd6b20;
    }
    
    .btn-danger {
      background: #f56565;
      color: white;
    }
    
    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
    }
    
    .stat-card.green {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .stat-card.purple {
      background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
    }
    
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
    }
    
    .stat-sub {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 8px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4299e1;
    }
    
    .info-box {
      background: #ebf8ff;
      border-left: 4px solid #4299e1;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .info-box.success {
      background: #f0fff4;
      border-color: #48bb78;
    }
    
    .info-box.warning {
      background: #fffaf0;
      border-color: #ed8936;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #2d3748;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-success {
      color: #48bb78;
    }
    
    .text-danger {
      color: #f56565;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-cash {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .badge-stocks {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .badge-gold {
      background: #feebc8;
      color: #7c2d12;
    }
    
    .badge-investment {
      background: #e9d8fd;
      color: #44337a;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #1a202c;
    }
    
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
    }
    
    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      background: #e2e8f0;
      color: #2d3748;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
    }
    
    .tab.active {
      background: #4299e1;
      color: white;
    }
    
    .tab:hover:not(.active) {
      background: #cbd5e0;
    }
    
    .footer {
      text-align: center;
      color: white;
      margin-top: 32px;
      font-size: 14px;
      line-height: 1.8;
    }
    
    .footer p {
      margin: 8px 0;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 4px;
      }
      
      .card {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card">
      <div class="header">
        <div>
          <h1>ğŸ’° Smart Asset Management System</h1>
          <p class="subtitle">å¤šå¹³å°èµ„äº§ç®¡ç† Â· å®æ—¶è¡Œæƒ… Â· æ™ºèƒ½åˆ†æ</p>
        </div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="toggleValues()">
            <span id="eyeIcon">ğŸ‘ï¸</span> <span id="eyeText">éšè—</span>
          </button>
          <button class="btn-primary" onclick="exportData()">ğŸ’¾ å¯¼å‡º</button>
          <button class="btn-success" onclick="document.getElementById('importFile').click()">
            ğŸ“¤ å¯¼å…¥å¤‡ä»½
          </button>
          <button class="btn-warning" onclick="document.getElementById('statementFile').click()">
            ğŸ“„ å¯¼å…¥è´¦å•
          </button>
          <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display:none">
          <input type="file" id="statementFile" accept=".xlsx,.xls,.csv,.pdf" onchange="importStatement(event)" style="display:none">
        </div>
      </div>

      <!-- APIé…ç½® -->
      <div class="info-box">
        <label>APIæœåŠ¡å™¨åœ°å€:</label>
        <div style="display:flex; gap:8px; margin-top:8px">
          <input 
            type="text" 
            id="apiUrl" 
            placeholder="https://your-app.onrender.com"
            style="flex:1"
          />
          <button class="btn-primary" onclick="testConnection()">ğŸ” æµ‹è¯•</button>
        </div>
        <p style="margin-top:8px; font-size:12px; color:#718096">
          ğŸ’¡ é…ç½®APIæœåŠ¡å™¨åå¯è·å–å®æ—¶è‚¡ä»·ã€é‡‘ä»·å’Œæ±‡ç‡
        </p>
      </div>

      <!-- å¯¼èˆªæ ‡ç­¾ -->
      <div class="tab-container">
        <div class="tab active" onclick="switchTab('overview', event)">ğŸ“Š æ€»è§ˆ</div>
        <div class="tab" onclick="switchTab('stocks', event)">ğŸ“ˆ è‚¡ç¥¨</div>
        <div class="tab" onclick="switchTab('gold', event)">ğŸ’ é»„é‡‘</div>
      </div>
    </div>

    <!-- æ€»è§ˆè§†å›¾ -->
    <div id="overview-view">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">æ€»èµ„äº§</div>
          <div class="stat-value" id="totalAssets">RM 0.00</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">å¯åŠ¨èµ„äº§</div>
          <div class="stat-value" id="liquidAssets">RM 0.00</div>
          <div class="stat-sub" id="liquidPercent">0% æ€»èµ„äº§</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">ä¸å¯åŠ¨èµ„äº§</div>
          <div class="stat-value" id="illiquidAssets">RM 0.00</div>
          <div class="stat-sub" id="illiquidPercent">0% æ€»èµ„äº§</div>
        </div>
      </div>

      <!-- å¯åŠ¨èµ„äº§ -->
      <div class="card">
        <div class="header">
          <h2>å¯åŠ¨èµ„äº§æ˜ç»†</h2>
          <button class="btn-primary" onclick="openAddAssetModal()">â• æ·»åŠ èµ„äº§</button>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>åç§°</th>
                <th>ç±»åˆ«</th>
                <th class="text-right">é‡‘é¢</th>
                <th>å¤‡æ³¨</th>
                <th class="text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="liquidAssetsTable">
              <tr>
                <td colspan="5" class="text-center" style="color:#a0aec0; padding:24px">
                  æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ èµ„äº§"å¼€å§‹
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ä¸å¯åŠ¨èµ„äº§ -->
      <div class="card">
        <h2 style="margin-bottom:16px">ä¸å¯åŠ¨èµ„äº§æ˜ç»†</h2>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>åç§°</th>
                <th class="text-right">é‡‘é¢</th>
                <th>å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody id="illiquidAssetsTable">
              <tr>
                <td colspan="3" class="text-center" style="color:#a0aec0; padding:24px">
                  æš‚æ— æ•°æ®
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è‚¡ç¥¨è§†å›¾ -->
    <div id="stocks-view" class="hidden">
      <!-- ç¾è‚¡ -->
      <div class="card">
        <div class="header">
          <h2>ğŸ‡ºğŸ‡¸ ç¾å›½è‚¡ç¥¨</h2>
          <div class="btn-group">
            <button class="btn-success" onclick="updateAllStockPrices()" id="updateStocksBtn">
              ğŸ”„ æ›´æ–°ä»·æ ¼
            </button>
            <button class="btn-primary" onclick="openAddStockModal()">â• æ·»åŠ è‚¡ç¥¨</button>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>ä»£ç </th>
                <th>åç§°</th>
                <th class="text-right">è‚¡æ•°</th>
                <th class="text-right">å¹³å‡æˆæœ¬</th>
                <th class="text-right">å½“å‰ä»·</th>
                <th class="text-right">æˆæœ¬æ€»é¢</th>
                <th class="text-right">å¸‚å€¼</th>
                <th class="text-right">æŸç›Š</th>
              </tr>
            </thead>
            <tbody id="usStocksTable">
              <tr>
                <td colspan="8" class="text-center" style="color:#a0aec0; padding:24px">
                  æš‚æ— æ•°æ®
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- é©¬è‚¡ -->
      <div class="card">
        <h2 style="margin-bottom:16px">ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºšè‚¡ç¥¨</h2>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>ä»£ç </th>
                <th>åç§°</th>
                <th class="text-right">è‚¡æ•°</th>
                <th class="text-right">å¹³å‡æˆæœ¬</th>
                <th class="text-right">å½“å‰ä»·</th>
                <th class="text-right">æˆæœ¬æ€»é¢</th>
                <th class="text-right">å¸‚å€¼</th>
                <th class="text-right">æŸç›Š</th>
              </tr>
            </thead>
            <tbody id="myStocksTable">
              <tr>
                <td colspan="8" class="text-center" style="color:#a0aec0; padding:24px">
                  æš‚æ— æ•°æ®
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- é»„é‡‘è§†å›¾ -->
    <div id="gold-view" class="hidden">
      <!-- é‡‘ä»·ä¿¡æ¯ -->
      <div class="card" style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color:white">
        <div class="header" style="color:white">
          <div>
            <h2 style="color:white; margin-bottom:8px">916é‡‘ä»·</h2>
            <p id="goldUpdateTime" style="font-size:12px; opacity:0.9">æœªæ›´æ–°</p>
          </div>
          <button class="btn-secondary" onclick="updateGoldPrice()" id="updateGoldBtn">
            ğŸ”„ æ›´æ–°é‡‘ä»·
          </button>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px">
          <div style="background:rgba(255,255,255,0.2); padding:16px; border-radius:8px">
            <div style="font-size:14px; opacity:0.9; margin-bottom:8px">é›¶å”®ä»·</div>
            <div style="font-size:28px; font-weight:bold" id="goldRetailPrice">RM 0.00</div>
            <div style="font-size:12px; margin-top:4px">æ¯å…‹</div>
          </div>
          <div style="background:rgba(255,255,255,0.2); padding:16px; border-radius:8px">
            <div style="font-size:14px; opacity:0.9; margin-bottom:8px">å›æ”¶ä»· (93%)</div>
            <div style="font-size:28px; font-weight:bold" id="goldBuybackPrice">RM 0.00</div>
            <div style="font-size:12px; margin-top:4px">æ¯å…‹</div>
          </div>
        </div>
      </div>

      <!-- é»„é‡‘æŒä»“ -->
      <div class="card">
        <div class="header">
          <h2>é»„é‡‘æŒä»“</h2>
          <button class="btn-warning" onclick="openAddGoldModal()">â• æ·»åŠ é»„é‡‘</button>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>åç§°</th>
                <th class="text-right">é‡é‡(å…‹)</th>
                <th class="text-right">è´­ä¹°ä»·</th>
                <th class="text-right">æˆæœ¬</th>
                <th class="text-right">å½“å‰ä»·å€¼</th>
                <th class="text-right">æŸç›Š</th>
                <th>å¤‡æ³¨</th>
              </tr>
            </thead>
            <tbody id="goldTable">
              <tr>
                <td colspan="7" class="text-center" style="color:#a0aec0; padding:24px">
                  æš‚æ— æ•°æ®
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>ğŸ’¡ æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¯·å®šæœŸå¯¼å‡ºå¤‡ä»½</p>
      <p>ğŸ”’ æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æ‚¨çš„è®¾å¤‡ä¸Šï¼Œå®Œå…¨ç§å¯†å®‰å…¨</p>
      <p>ğŸ“± æ”¯æŒå¤šå¹³å°ï¼šMOOMOO, Webull, é€šç”¨åˆ¸å•†è´¦å•</p>
      <p style="margin-top:16px; font-size:12px; opacity:0.8">
        Smart Asset Management System v1.0 | Created with â¤ï¸
      </p>
    </div>
  </div>

  <!-- æ·»åŠ èµ„äº§æ¨¡æ€æ¡† -->
  <div id="addAssetModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-header">æ·»åŠ èµ„äº§</h3>
      <form id="addAssetForm">
        <div class="input-group">
          <label>åç§°</label>
          <input type="text" name="name" required>
        </div>
        <div class="input-group">
          <label>é‡‘é¢</label>
          <input type="number" name="value" step="0.01" required>
        </div>
        <div class="input-group">
          <label>ç±»åˆ«</label>
          <select name="category" required>
            <option value="cash">ç°é‡‘</option>
            <option value="stocks">è‚¡ç¥¨</option>
            <option value="gold">é»„é‡‘</option>
            <option value="investment">æŠ•èµ„</option>
          </select>
        </div>
        <div class="input-group">
          <label>ç±»å‹</label>
          <select name="type" required>
            <option value="liquid">å¯åŠ¨èµ„äº§</option>
            <option value="illiquid">ä¸å¯åŠ¨èµ„äº§</option>
          </select>
        </div>
        <div class="input-group">
          <label>å¤‡æ³¨</label>
          <input type="text" name="notes">
        </div>
        <div style="display:flex; gap:8px; margin-top:20px">
          <button type="submit" class="btn-primary" style="flex:1">æ·»åŠ </button>
          <button type="button" class="btn-secondary" style="flex:1" onclick="closeModal('addAssetModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ·»åŠ è‚¡ç¥¨æ¨¡æ€æ¡† -->
  <div id="addStockModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-header">æ·»åŠ è‚¡ç¥¨</h3>
      <form id="addStockForm">
        <div class="input-group">
          <label>è‚¡ç¥¨ä»£ç </label>
          <input type="text" name="symbol" required placeholder="VOO, AAPL">
        </div>
        <div class="input-group">
          <label>è‚¡ç¥¨åç§°</label>
          <input type="text" name="name" required>
        </div>
        <div class="input-group">
          <label>æŒæœ‰è‚¡æ•°</label>
          <input type="number" name="shares" step="0.01" required>
        </div>
        <div class="input-group">
          <label>å¹³å‡æˆæœ¬</label>
          <input type="number" name="avgPrice" step="0.01" required>
        </div>
        <div class="input-group">
          <label>å¸‚åœº</label>
          <select name="exchange" required>
            <option value="US">ç¾å›½ (US)</option>
            <option value="MY">é©¬æ¥è¥¿äºš (MY)</option>
          </select>
        </div>
        <div style="display:flex; gap:8px; margin-top:20px">
          <button type="submit" class="btn-primary" style="flex:1">æ·»åŠ </button>
          <button type="button" class="btn-secondary" style="flex:1" onclick="closeModal('addStockModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ·»åŠ é»„é‡‘æ¨¡æ€æ¡† -->
  <div id="addGoldModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-header">æ·»åŠ é»„é‡‘</h3>
      <form id="addGoldForm">
        <div class="input-group">
          <label>åç§°</label>
          <input type="text" name="name" required placeholder="916é‡‘é¡¹é“¾">
        </div>
        <div class="input-group">
          <label>é‡é‡(å…‹)</label>
          <input type="number" name="weight" step="0.01" required>
        </div>
        <div class="input-group">
          <label>è´­ä¹°ä»·(æ¯å…‹)</label>
          <input type="number" name="buyPrice" step="0.01" required>
        </div>
        <div class="input-group">
          <label>å¤‡æ³¨</label>
          <input type="text" name="notes">
        </div>
        <div style="display:flex; gap:8px; margin-top:20px">
          <button type="submit" class="btn-warning" style="flex:1">æ·»åŠ </button>
          <button type="button" class="btn-secondary" style="flex:1" onclick="closeModal('addGoldModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // æ•°æ®ç»“æ„
    let assets = {
      liquid: [],
      illiquid: [],
      stocks: { us: [], malaysia: [] },
      gold: []
    };
    
    let showValues = true;
    let goldPrice = { retail: 0, buyback: 0, updated: '' };
    
    // åˆå§‹åŒ–
    function init() {
      loadData();
      loadApiUrl();
      updateUI();
      setupEventListeners();
    }
    
    // åŠ è½½æ•°æ®
    function loadData() {
      const saved = localStorage.getItem('smartAssets');
      if (saved) {
        try {
          assets = JSON.parse(saved);
        } catch (e) {
          console.error('åŠ è½½æ•°æ®å¤±è´¥', e);
        }
      }
    }
    
    // ä¿å­˜æ•°æ®
    function saveData() {
      localStorage.setItem('smartAssets', JSON.stringify(assets));
    }
    
    // åŠ è½½APIåœ°å€
    function loadApiUrl() {
      const saved = localStorage.getItem('apiUrl');
      if (saved) {
        document.getElementById('apiUrl').value = saved;
      }
    }
    
    // ä¿å­˜APIåœ°å€
    function saveApiUrl() {
      const url = document.getElementById('apiUrl').value;
      if (url) {
        localStorage.setItem('apiUrl', url);
      }
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      document.getElementById('addAssetForm').addEventListener('submit', handleAddAsset);
      document.getElementById('addStockForm').addEventListener('submit', handleAddStock);
      document.getElementById('addGoldForm').addEventListener('submit', handleAddGold);
      document.getElementById('apiUrl').addEventListener('change', saveApiUrl);
    }
    
    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(tabName, event) {
      // æ›´æ–°æ ‡ç­¾æ ·å¼
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // æ˜¾ç¤ºå¯¹åº”è§†å›¾
      document.getElementById('overview-view').classList.add('hidden');
      document.getElementById('stocks-view').classList.add('hidden');
      document.getElementById('gold-view').classList.add('hidden');
      document.getElementById(tabName + '-view').classList.remove('hidden');
    }
    
    // åˆ‡æ¢æ˜¾ç¤º/éšè—é‡‘é¢
    function toggleValues() {
      showValues = !showValues;
      document.getElementById('eyeIcon').textContent = showValues ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
      document.getElementById('eyeText').textContent = showValues ? 'éšè—' : 'æ˜¾ç¤º';
      updateUI();
    }
    
    // è®¡ç®—æ€»èµ„äº§
    function calculateTotal() {
      const liquid = assets.liquid.reduce((sum, item) => sum + parseFloat(item.value || 0), 0);
      const illiquid = assets.illiquid.reduce((sum, item) => sum + parseFloat(item.value || 0), 0);
      return { liquid, illiquid, total: liquid + illiquid };
    }
    
    // æ ¼å¼åŒ–é‡‘é¢
    function formatMoney(value) {
      if (!showValues) return '****';
      return 'RM ' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }
    
    // æ›´æ–°UI
    function updateUI() {
      const totals = calculateTotal();
      
      // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
      document.getElementById('totalAssets').textContent = formatMoney(totals.total);
      document.getElementById('liquidAssets').textContent = formatMoney(totals.liquid);
      document.getElementById('illiquidAssets').textContent = formatMoney(totals.illiquid);
      
      if (totals.total > 0) {
        document.getElementById('liquidPercent').textContent = 
          ((totals.liquid / totals.total) * 100).toFixed(1) + '% æ€»èµ„äº§';
        document.getElementById('illiquidPercent').textContent = 
          ((totals.illiquid / totals.total) * 100).toFixed(1) + '% æ€»èµ„äº§';
      }
      
      // æ›´æ–°èµ„äº§è¡¨æ ¼
      updateAssetsTable();
      updateStocksTable();
      updateGoldTable();
    }
    
    // æ›´æ–°èµ„äº§è¡¨æ ¼
    function updateAssetsTable() {
      const liquidTable = document.getElementById('liquidAssetsTable');
      const illiquidTable = document.getElementById('illiquidAssetsTable');
      
      if (assets.liquid.length === 0) {
        liquidTable.innerHTML = '<tr><td colspan="5" class="text-center" style="color:#a0aec0; padding:24px">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ èµ„äº§"å¼€å§‹</td></tr>';
      } else {
        liquidTable.innerHTML = assets.liquid.map(asset => `
          <tr>
            <td>${asset.name}</td>
            <td><span class="badge badge-${asset.category}">${asset.category}</span></td>
            <td class="text-right" style="font-weight:600">${formatMoney(asset.value)}</td>
            <td style="color:#718096">${asset.notes || '-'}</td>
            <td class="text-center">
              <button class="btn-danger" style="padding:6px 12px; font-size:12px" onclick="deleteAsset('liquid', ${asset.id})">åˆ é™¤</button>
            </td>
          </tr>
        `).join('');
      }
      
      if (assets.illiquid.length === 0) {
        illiquidTable.innerHTML = '<tr><td colspan="3" class="text-center" style="color:#a0aec0; padding:24px">æš‚æ— æ•°æ®</td></tr>';
      } else {
        illiquidTable.innerHTML = assets.illiquid.map(asset => `
          <tr>
            <td>${asset.name}</td>
            <td class="text-right" style="font-weight:600">${formatMoney(asset.value)}</td>
            <td style="color:#718096">${asset.notes || '-'}</td>
          </tr>
        `).join('');
      }
    }
    
    // æ›´æ–°è‚¡ç¥¨è¡¨æ ¼
    function updateStocksTable() {
      const usTable = document.getElementById('usStocksTable');
      const myTable = document.getElementById('myStocksTable');
      
      if (assets.stocks.us.length === 0) {
        usTable.innerHTML = '<tr><td colspan="8" class="text-center" style="color:#a0aec0; padding:24px">æš‚æ— æ•°æ®</td></tr>';
      } else {
        usTable.innerHTML = assets.stocks.us.map(stock => {
          const totalCost = stock.shares * stock.avgPrice;
          const currentPrice = stock.currentPrice || stock.avgPrice;
          const marketValue = stock.shares * currentPrice;
          const pl = marketValue - totalCost;
          const plPercent = (pl / totalCost) * 100;
          
          return `
            <tr>
              <td style="font-weight:600">${stock.symbol}</td>
              <td>${stock.name}</td>
              <td class="text-right">${stock.shares}</td>
              <td class="text-right">$${stock.avgPrice.toFixed(2)}</td>
              <td class="text-right">$${currentPrice.toFixed(2)}</td>
              <td class="text-right">$${totalCost.toFixed(2)}</td>
              <td class="text-right" style="font-weight:600">$${marketValue.toFixed(2)}</td>
              <td class="text-right ${pl >= 0 ? 'text-success' : 'text-danger'}" style="font-weight:600">
                $${pl.toFixed(2)} (${plPercent.toFixed(2)}%)
              </td>
            </tr>
          `;
        }).join('');
      }
      
      if (assets.stocks.malaysia.length === 0) {
        myTable.innerHTML = '<tr><td colspan="8" class="text-center" style="color:#a0aec0; padding:24px">æš‚æ— æ•°æ®</td></tr>';
      } else {
        myTable.innerHTML = assets.stocks.malaysia.map(stock => {
          const totalCost = stock.shares * stock.avgPrice;
          const currentPrice = stock.currentPrice || stock.avgPrice;
          const marketValue = stock.shares * currentPrice;
          const pl = marketValue - totalCost;
          const plPercent = (pl / totalCost) * 100;
          
          return `
            <tr>
              <td style="font-weight:600">${stock.symbol}</td>
              <td>${stock.name}</td>
              <td class="text-right">${stock.shares}</td>
              <td class="text-right">RM ${stock.avgPrice.toFixed(2)}</td>
              <td class="text-right">RM ${currentPrice.toFixed(2)}</td>
              <td class="text-right">RM ${totalCost.toFixed(2)}</td>
              <td class="text-right" style="font-weight:600">RM ${marketValue.toFixed(2)}</td>
              <td class="text-right ${pl >= 0 ? 'text-success' : 'text-danger'}" style="font-weight:600">
                RM ${pl.toFixed(2)} (${plPercent.toFixed(2)}%)
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // æ›´æ–°é»„é‡‘è¡¨æ ¼
    function updateGoldTable() {
      const table = document.getElementById('goldTable');
      
      if (assets.gold.length === 0) {
        table.innerHTML = '<tr><td colspan="7" class="text-center" style="color:#a0aec0; padding:24px">æš‚æ— æ•°æ®</td></tr>';
      } else {
        table.innerHTML = assets.gold.map(item => {
          const cost = item.weight * item.buyPrice;
          const currentValue = goldPrice.buyback > 0 ? item.weight * goldPrice.buyback : cost;
          const pl = currentValue - cost;
          const plPercent = (pl / cost) * 100;
          
          return `
            <tr>
              <td>${item.name}</td>
              <td class="text-right">${item.weight}</td>
              <td class="text-right">RM ${item.buyPrice.toFixed(2)}</td>
              <td class="text-right">RM ${cost.toFixed(2)}</td>
              <td class="text-right" style="font-weight:600">RM ${currentValue.toFixed(2)}</td>
              <td class="text-right ${pl >= 0 ? 'text-success' : 'text-danger'}" style="font-weight:600">
                RM ${pl.toFixed(2)} (${plPercent.toFixed(2)}%)
              </td>
              <td style="color:#718096">${item.notes || '-'}</td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // æ¨¡æ€æ¡†æ“ä½œ
    function openAddAssetModal() {
      document.getElementById('addAssetModal').classList.add('active');
    }
    
    function openAddStockModal() {
      document.getElementById('addStockModal').classList.add('active');
    }
    
    function openAddGoldModal() {
      document.getElementById('addGoldModal').classList.add('active');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // å¤„ç†è¡¨å•æäº¤
    function handleAddAsset(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const asset = {
        id: Date.now(),
        name: formData.get('name'),
        value: parseFloat(formData.get('value')),
        category: formData.get('category'),
        notes: formData.get('notes')
      };
      
      const type = formData.get('type');
      assets[type].push(asset);
      
      saveData();
      updateUI();
      closeModal('addAssetModal');
      e.target.reset();
    }
    
    function handleAddStock(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const stock = {
        symbol: formData.get('symbol'),
        name: formData.get('name'),
        shares: parseFloat(formData.get('shares')),
        avgPrice: parseFloat(formData.get('avgPrice')),
        currentPrice: 0,
        exchange: formData.get('exchange')
      };
      
      const market = stock.exchange === 'US' ? 'us' : 'malaysia';
      assets.stocks[market].push(stock);
      
      saveData();
      updateUI();
      closeModal('addStockModal');
      e.target.reset();
    }
    
    function handleAddGold(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const gold = {
        id: Date.now(),
        name: formData.get('name'),
        weight: parseFloat(formData.get('weight')),
        buyPrice: parseFloat(formData.get('buyPrice')),
        notes: formData.get('notes')
      };
      
      assets.gold.push(gold);
      
      saveData();
      updateUI();
      closeModal('addGoldModal');
      e.target.reset();
    }
    
    // åˆ é™¤èµ„äº§
    function deleteAsset(type, id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é¡¹èµ„äº§å—ï¼Ÿ')) {
        assets[type] = assets[type].filter(item => item.id !== id);
        saveData();
        updateUI();
      }
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const dataStr = JSON.stringify(assets, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `èµ„äº§æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
    }
    
    // å¯¼å…¥æ•°æ®
    function importData(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            assets = JSON.parse(e.target.result);
            saveData();
            updateUI();
            alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
          } catch (error) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
          }
        };
        reader.readAsText(file);
      }
    }
    
    // å¯¼å…¥è´¦å•
    async function importStatement(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆé…ç½®APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file);
      
      try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loadingMsg';
        loadingMsg.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:2000; text-align:center;';
        loadingMsg.innerHTML = '<div class="loading" style="width:40px; height:40px; margin:0 auto 16px"></div><div style="font-size:18px; font-weight:600">æ­£åœ¨è§£æè´¦å•...</div><div style="color:#718096; margin-top:8px">è¯·ç¨å€™</div>';
        document.body.appendChild(loadingMsg);
        
        const response = await fetch(`${apiUrl}/api/parse-statement`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        // ç§»é™¤åŠ è½½æç¤º
        document.body.removeChild(loadingMsg);
        
        if (result.success) {
          // åˆå¹¶æ•°æ®
          const data = result.data;
          
          let totalImported = 0;
          
          // åˆå¹¶å¯åŠ¨èµ„äº§
          if (data.liquid_assets && data.liquid_assets.length > 0) {
            data.liquid_assets.forEach(asset => {
              if (!isNaN(asset.value) && asset.value > 0) {
                assets.liquid.push({
                  id: Date.now() + Math.random(),
                  ...asset
                });
                totalImported++;
              }
            });
          }
          
          // åˆå¹¶ä¸å¯åŠ¨èµ„äº§
          if (data.illiquid_assets && data.illiquid_assets.length > 0) {
            data.illiquid_assets.forEach(asset => {
              if (!isNaN(asset.value) && asset.value > 0) {
                assets.illiquid.push({
                  id: Date.now() + Math.random(),
                  ...asset
                });
                totalImported++;
              }
            });
          }
          
          // åˆå¹¶é©¬è‚¡
          if (data.stocks_my && data.stocks_my.length > 0) {
            assets.stocks.malaysia.push(...data.stocks_my);
            totalImported += data.stocks_my.length;
          }
          
          // åˆå¹¶ç¾è‚¡
          if (data.stocks_us && data.stocks_us.length > 0) {
            assets.stocks.us.push(...data.stocks_us);
            totalImported += data.stocks_us.length;
          }
          
          // åˆå¹¶é»„é‡‘
          if (data.gold && data.gold.length > 0) {
            data.gold.forEach(gold => {
              assets.gold.push({
                id: Date.now() + Math.random(),
                ...gold
              });
              totalImported++;
            });
          }
          
          saveData();
          updateUI();
          
          alert(`âœ… è´¦å•å¯¼å…¥æˆåŠŸï¼\n\nå…±å¯¼å…¥ ${totalImported} é¡¹èµ„äº§\n- å¯åŠ¨èµ„äº§: ${data.liquid_assets.length}\n- ä¸å¯åŠ¨èµ„äº§: ${data.illiquid_assets.length}\n- é©¬è‚¡: ${data.stocks_my.length}\n- ç¾è‚¡: ${data.stocks_us.length}\n- é»„é‡‘: ${data.gold.length}`);
        } else {
          alert('âŒ è´¦å•è§£æå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        // ç§»é™¤åŠ è½½æç¤º
        const loadingMsg = document.getElementById('loadingMsg');
        if (loadingMsg) document.body.removeChild(loadingMsg);
        
        alert('âŒ è´¦å•å¯¼å…¥å¤±è´¥: ' + error.message);
      }
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      event.target.value = '';
    }
    
    // API åŠŸèƒ½
    async function testConnection() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      
      try {
        const response = await fetch(`${apiUrl}/api/health`);
        const data = await response.json();
        alert('âœ… APIè¿æ¥æˆåŠŸï¼\n' + JSON.stringify(data, null, 2));
      } catch (error) {
        alert('âŒ è¿æ¥å¤±è´¥: ' + error.message);
      }
    }
    
    async function updateGoldPrice() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      
      const btn = document.getElementById('updateGoldBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> æ›´æ–°ä¸­...';
      
      try {
        const response = await fetch(`${apiUrl}/api/gold-price`);
        const result = await response.json();
        
        if (result.success) {
          goldPrice.retail = result.data.gold_916;
          goldPrice.buyback = result.data.gold_916_buyback_93;
          goldPrice.updated = result.data.last_updated;
          
          document.getElementById('goldRetailPrice').textContent = `RM ${goldPrice.retail.toFixed(2)}`;
          document.getElementById('goldBuybackPrice').textContent = `RM ${goldPrice.buyback.toFixed(2)}`;
          document.getElementById('goldUpdateTime').textContent = `æ›´æ–°æ—¶é—´: ${goldPrice.updated}`;
          
          updateGoldTable();
          alert(`âœ… é‡‘ä»·å·²æ›´æ–°ï¼\né›¶å”®ä»·ï¼šRM ${goldPrice.retail}/å…‹\nå›æ”¶ä»·ï¼šRM ${goldPrice.buyback}/å…‹`);
        }
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ æ›´æ–°é‡‘ä»·';
      }
    }
    
    async function updateAllStockPrices() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆé…ç½®APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      
      const btn = document.getElementById('updateStocksBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> æ›´æ–°ä¸­...';
      
      try {
        let updated = 0;
        
        // æ›´æ–°ç¾è‚¡
        for (let stock of assets.stocks.us) {
          try {
            const response = await fetch(`${apiUrl}/api/stock-price/${stock.symbol}?exchange=US`);
            const result = await response.json();
            if (result.success) {
              stock.currentPrice = result.data.price;
              updated++;
            }
          } catch (e) {
            console.error(`æ›´æ–° ${stock.symbol} å¤±è´¥:`, e);
          }
        }
        
        // æ›´æ–°é©¬è‚¡
        for (let stock of assets.stocks.malaysia) {
          try {
            const response = await fetch(`${apiUrl}/api/stock-price/${stock.symbol}?exchange=MY`);
            const result = await response.json();
            if (result.success) {
              stock.currentPrice = result.data.price;
              updated++;
            }
          } catch (e) {
            console.error(`æ›´æ–° ${stock.symbol} å¤±è´¥:`, e);
          }
        }
        
        saveData();
        updateUI();
        alert(`âœ… è‚¡ç¥¨ä»·æ ¼å·²æ›´æ–°ï¼\næˆåŠŸæ›´æ–° ${updated} åªè‚¡ç¥¨`);
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”„ æ›´æ–°ä»·æ ¼';
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
