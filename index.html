<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½èµ„äº§ç®¡ç†ç³»ç»Ÿ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- æ­£ç¡®çš„Recharts CDNé“¾æ¥ -->
  <script src="https://unpkg.com/recharts@2.10.3/dist/Recharts.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    // ç®€å•çš„å›¾æ ‡ç»„ä»¶
    const RefreshIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
      </svg>
    );

    const AssetManager = () => {
      // æ¼”ç¤ºæ•°æ®
      const defaultAssets = {
        liquid: [
          { name: 'ç°é‡‘è´¦æˆ·', value: 5000, category: 'cash' },
          { name: 'è‚¡ç¥¨æŠ•èµ„', value: 50000, category: 'stocks' },
          { name: 'é»„é‡‘', value: 15000, category: 'gold' },
          { name: 'åŸºé‡‘', value: 10000, category: 'investment' }
        ],
        illiquid: [
          { name: 'KWSPé€€ä¼‘é‡‘', value: 25000, category: 'retirement' }
        ]
      };

      const [assets, setAssets] = useState(defaultAssets);
      const [loading, setLoading] = useState(false);
      const [apiUrl, setApiUrl] = useState('');
      const [showValues, setShowValues] = useState(true);

      // ä»localStorageåŠ è½½æ•°æ®
      useEffect(() => {
        const savedAssets = localStorage.getItem('assets');
        if (savedAssets) {
          try {
            setAssets(JSON.parse(savedAssets));
          } catch (e) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥', e);
          }
        }

        const savedApiUrl = localStorage.getItem('apiUrl');
        if (savedApiUrl) {
          setApiUrl(savedApiUrl);
        }
      }, []);

      // ä¿å­˜æ•°æ®åˆ°localStorage
      useEffect(() => {
        localStorage.setItem('assets', JSON.stringify(assets));
      }, [assets]);

      useEffect(() => {
        localStorage.setItem('apiUrl', apiUrl);
      }, [apiUrl]);

      const calculateTotalAssets = () => {
        const liquidTotal = assets.liquid.reduce((sum, item) => sum + item.value, 0);
        const illiquidTotal = assets.illiquid.reduce((sum, item) => sum + item.value, 0);
        return liquidTotal + illiquidTotal;
      };

      const calculateLiquidAssets = () => {
        return assets.liquid.reduce((sum, item) => sum + item.value, 0);
      };

      const calculateIlliquidAssets = () => {
        return assets.illiquid.reduce((sum, item) => sum + item.value, 0);
      };

      // æµ‹è¯•APIè¿æ¥
      const testApiConnection = async () => {
        if (!apiUrl) {
          alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
          return;
        }

        setLoading(true);
        try {
          const response = await fetch(`${apiUrl}/api/health`);
          const result = await response.json();
          
          if (result.status === 'ok') {
            alert('âœ… APIè¿æ¥æˆåŠŸï¼\næœåŠ¡å™¨æ­£å¸¸è¿è¡Œ');
          } else {
            alert('âš ï¸ APIå“åº”å¼‚å¸¸');
          }
        } catch (error) {
          alert('âŒ æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨\nè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®');
        } finally {
          setLoading(false);
        }
      };

      // æ›´æ–°é‡‘ä»·
      const updateGoldPrice = async () => {
        if (!apiUrl) {
          alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
          return;
        }

        setLoading(true);
        try {
          const response = await fetch(`${apiUrl}/api/gold-price`);
          const result = await response.json();
          
          if (result.success) {
            alert(`âœ… é‡‘ä»·å·²æ›´æ–°ï¼\n916é‡‘ï¼šRM ${result.data.gold_916}/å…‹\nå›æ”¶ä»·ï¼šRM ${result.data.gold_916_buyback_93}/å…‹`);
          } else {
            alert('âŒ è·å–é‡‘ä»·å¤±è´¥');
          }
        } catch (error) {
          alert('âŒ æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨');
        } finally {
          setLoading(false);
        }
      };

      // å¯¼å‡ºæ•°æ®
      const exportData = () => {
        const dataStr = JSON.stringify(assets, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `èµ„äº§æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
      };

      // å¯¼å…¥æ•°æ®
      const importData = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result);
              setAssets(imported);
              alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
              alert('âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }
          };
          reader.readAsText(file);
        }
      };

      const assetDistributionData = [
        { name: 'å¯åŠ¨èµ„äº§', value: calculateLiquidAssets() },
        { name: 'ä¸å¯åŠ¨èµ„äº§', value: calculateIlliquidAssets() }
      ];

      const categoryData = assets.liquid.reduce((acc, item) => {
        const existing = acc.find(a => a.name === item.category);
        if (existing) {
          existing.value += item.value;
        } else {
          acc.push({ name: item.category, value: item.value });
        }
        return acc;
      }, []);

      const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D'];

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div className="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h1 className="text-3xl font-bold text-gray-800">ğŸ’° æ™ºèƒ½èµ„äº§ç®¡ç†ç³»ç»Ÿ</h1>
                <div className="flex gap-2">
                  <button
                    onClick={exportData}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                  >
                    ğŸ“¥ å¯¼å‡ºæ•°æ®
                  </button>
                  <label className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer">
                    ğŸ“¤ å¯¼å…¥æ•°æ®
                    <input type="file" accept=".json" onChange={importData} className="hidden" />
                  </label>
                  <button
                    onClick={() => setShowValues(!showValues)}
                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                  >
                    {showValues ? 'ğŸ‘ï¸ éšè—' : 'ğŸ‘ï¸ æ˜¾ç¤º'}
                  </button>
                </div>
              </div>

              {/* æ€»èµ„äº§æ˜¾ç¤º */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                  <div className="text-sm opacity-90">æ€»èµ„äº§</div>
                  <div className="text-3xl font-bold">
                    {showValues ? `RM ${calculateTotalAssets().toLocaleString()}` : '****'}
                  </div>
                </div>
                <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                  <div className="text-sm opacity-90">å¯åŠ¨èµ„äº§</div>
                  <div className="text-3xl font-bold">
                    {showValues ? `RM ${calculateLiquidAssets().toLocaleString()}` : '****'}
                  </div>
                </div>
                <div className="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                  <div className="text-sm opacity-90">ä¸å¯åŠ¨èµ„äº§</div>
                  <div className="text-3xl font-bold">
                    {showValues ? `RM ${calculateIlliquidAssets().toLocaleString()}` : '****'}
                  </div>
                </div>
              </div>

              {/* APIé…ç½® */}
              <div className="p-4 bg-gray-50 rounded-lg">
                <label className="block mb-2 text-sm font-semibold">APIæœåŠ¡å™¨åœ°å€:</label>
                <input
                  type="text"
                  value={apiUrl}
                  onChange={(e) => setApiUrl(e.target.value)}
                  className="w-full px-4 py-2 border rounded-lg mb-2"
                  placeholder="https://your-api.onrender.com"
                />
                <div className="flex gap-2 flex-wrap">
                  <button
                    onClick={testApiConnection}
                    disabled={loading}
                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <RefreshIcon />
                    {loading ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•APIè¿æ¥'}
                  </button>
                  <button
                    onClick={updateGoldPrice}
                    disabled={loading}
                    className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    ğŸ’° æ›´æ–°é‡‘ä»·
                  </button>
                </div>
                <p className="mt-2 text-xs text-gray-600">
                  ğŸ’¡ è¾“å…¥ä½ çš„Render APIåœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://your-app.onrender.com
                </p>
              </div>
            </div>

            {/* å›¾è¡¨åŒºåŸŸ */}
            <div className="bg-white rounded-lg shadow-lg p-6">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <h3 className="text-xl font-bold mb-4">èµ„äº§åˆ†å¸ƒ</h3>
                  <ResponsiveContainer width="100%" height={300}>
                    <PieChart>
                      <Pie
                        data={assetDistributionData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {assetDistributionData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => `RM ${value.toLocaleString()}`} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>

                <div>
                  <h3 className="text-xl font-bold mb-4">èµ„äº§ç±»åˆ«</h3>
                  <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={categoryData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip formatter={(value) => `RM ${value.toLocaleString()}`} />
                      <Bar dataKey="value" fill="#8884d8">
                        {categoryData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              {/* ä½¿ç”¨è¯´æ˜ */}
              <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                <h4 className="font-semibold mb-2">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                <ol className="list-decimal list-inside space-y-1 text-sm">
                  <li>è¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼ŒåŒ…å«ç¤ºä¾‹æ•°æ®</li>
                  <li>ç‚¹å‡»"å¯¼å‡ºæ•°æ®"ä¿å­˜ä½ çš„èµ„äº§ä¿¡æ¯</li>
                  <li>ç‚¹å‡»"å¯¼å…¥æ•°æ®"æ¢å¤ä¹‹å‰ä¿å­˜çš„æ•°æ®</li>
                  <li>è¾“å…¥ä½ çš„Render APIåœ°å€ï¼Œç‚¹å‡»"æµ‹è¯•APIè¿æ¥"</li>
                  <li>è¿æ¥æˆåŠŸåå¯ä»¥ä½¿ç”¨"æ›´æ–°é‡‘ä»·"ç­‰åŠŸèƒ½</li>
                  <li>æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œå®Œå…¨ç§å¯†</li>
                </ol>
              </div>
            </div>

            {/* Footer */}
            <div className="mt-6 text-center text-gray-600 text-sm">
              <p>ğŸ’¡ æç¤ºï¼šæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œè¯·å®šæœŸå¯¼å‡ºå¤‡ä»½</p>
              <p className="mt-1">ğŸ”’ æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æ‚¨çš„è®¾å¤‡ä¸Šï¼Œå®Œå…¨ç§å¯†å®‰å…¨</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<AssetManager />, document.getElementById('root'));
  </script>
</body>
</html>
