import google.generativeai as genai
import PIL.Image
import os
import io
import json

class AIAssetStatementParser:
    def __init__(self):
        # 配置 Google Gemini
        self.google_api_key = os.getenv('GOOGLE_API_KEY', '')
        if self.google_api_key:
            genai.configure(api_key=self.google_api_key)

    def _parse_image_with_google(self, file_content):
        """使用 Google Gemini 1.5 Flash 识别图片内容"""
        if not self.google_api_key:
            return {'success': False, 'error': '未配置 GOOGLE_API_KEY'}

        try:
            # 1. 准备图片数据
            image = PIL.Image.open(io.BytesIO(file_content))
            
            # 2. 初始化模型 (Flash 模型速度快且有免费额度)
            model = genai.GenerativeModel('gemini-1.5-flash')
            
            # 3. 编写针对财务提取的提示词
            prompt = """
            你是一个专业的财务审计机器人。请分析这张图片，提取所有的资产信息。
            特别注意：
            1. 识别马股代码（4位数字）和美股代码（大写字母）。
            2. 识别现金余额、定期存款。
            3. 识别黄金重量。
            
            请直接返回如下格式的 JSON，不要包含任何多余的文字或 markdown 标记：
            {
              "stocks_my": [{"symbol": "1155", "shares": 100, "avgPrice": 9.20}],
              "stocks_us": [],
              "cash_balance": 1234.56,
              "gold": [],
              "liquid_assets": [{"name": "银行存款", "value": 1000}]
            }
            """
            
            # 4. 发送请求
            response = model.generate_content([prompt, image])
            
            # 5. 清洗并解析返回的内容
            text = response.text
            # 去掉可能的 ```json 标记
            json_text = text.replace('```json', '').replace('```', '').strip()
            data = json.loads(json_text)
            
            return {'success': True, 'data': data}
            
        except Exception as e:
            return {'success': False, 'error': f'Google AI 识别失败: {str(e)}'}
