<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"="width=device-width, initial-scale=1.0">
  <title>ğŸ¤– AIèµ„äº§ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100">
  <div class="container mx-auto p-4 md:p-8">
    <div class="bg-white rounded-lg shadow-xl p-6">
      <!-- Header -->
      <div class="border-b pb-4 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          ğŸ¤– AIæ™ºèƒ½èµ„äº§ç®¡ç†ç³»ç»Ÿ
        </h1>
        <p class="text-gray-600">ä½¿ç”¨AIæŠ€æœ¯è‡ªåŠ¨è¯†åˆ«å’Œåˆ†ææ‚¨çš„èµ„äº§è´¦å•</p>
      </div>

      <!-- APIé…ç½® -->
      <div class="mb-6 p-4 bg-blue-50 rounded-lg">
        <label class="block mb-2 font-semibold text-gray-700">ğŸ”§ APIæœåŠ¡å™¨åœ°å€:</label>
        <input 
          type="text" 
          id="apiUrl" 
          class="w-full px-4 py-2 border rounded-lg mb-3 focus:ring-2 focus:ring-blue-500"
          placeholder="https://your-api.onrender.com"
        />
        <div class="flex gap-2 flex-wrap">
          <button 
            onclick="testApi()" 
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
          >
            ğŸ” æµ‹è¯•è¿æ¥
          </button>
          <button 
            onclick="getGoldPrice()" 
            class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition"
          >
            ğŸ’° è·å–é‡‘ä»·
          </button>
        </div>
      </div>

      <!-- AIè´¦å•ä¸Šä¼  -->
      <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
          ğŸ¤– AIæ™ºèƒ½è´¦å•è§£æ
        </h2>
        <p class="text-gray-600 mb-4">
          ä¸Šä¼ æ‚¨çš„åˆ¸å•†æœˆç»“å•ï¼ˆPDF/Excelï¼‰ï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«è‚¡ç¥¨æŒä»“ã€èµ„äº§åˆ†é…ç­‰ä¿¡æ¯
        </p>
        
        <div class="mb-4">
          <label class="block mb-2 font-semibold text-gray-700">
            ğŸ“„ é€‰æ‹©æ–‡ä»¶ (æ”¯æŒPDF, Excel):
          </label>
          <input 
            type="file" 
            id="statementFile" 
            accept=".pdf,.xlsx,.xls"
            class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg focus:border-purple-500 cursor-pointer"
          />
          <p class="text-sm text-gray-500 mt-2">
            âœ… æ”¯æŒæ ¼å¼: MOOMOO, Webull, å¯Œé€”ç­‰åˆ¸å•†PDFè´¦å• | Excelèµ„äº§è¡¨
          </p>
        </div>

        <button 
          onclick="uploadStatement()" 
          id="uploadBtn"
          class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-lg hover:from-purple-600 hover:to-pink-600 transition shadow-lg"
        >
          ğŸš€ å¼€å§‹AIè§£æ
        </button>
      </div>

      <!-- ç»“æœæ˜¾ç¤º -->
      <div id="result" class="p-6 bg-gray-50 rounded-lg min-h-[200px] border">
        <p class="text-gray-500 text-center">ç­‰å¾…æ“ä½œ...</p>
      </div>

      <!-- ä½¿ç”¨è¯´æ˜ -->
      <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
        <h3 class="font-bold text-green-800 mb-3">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
          <li><strong>é…ç½®API:</strong> è¾“å…¥Render APIåœ°å€ï¼Œç‚¹å‡»"æµ‹è¯•è¿æ¥"</li>
          <li><strong>ä¸Šä¼ è´¦å•:</strong> é€‰æ‹©PDFæˆ–Excelæ–‡ä»¶</li>
          <li><strong>AIè§£æ:</strong> ç‚¹å‡»"å¼€å§‹AIè§£æ"ï¼Œç­‰å¾…10-30ç§’</li>
          <li><strong>æŸ¥çœ‹ç»“æœ:</strong> AIä¼šè‡ªåŠ¨æå–è‚¡ç¥¨ä»£ç ã€æ•°é‡ã€æˆæœ¬ç­‰ä¿¡æ¯</li>
          <li><strong>éªŒè¯æ•°æ®:</strong> è¯·æ£€æŸ¥AIæå–çš„æ•°æ®æ˜¯å¦å‡†ç¡®</li>
        </ol>
      </div>

      <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
        <h3 class="font-bold text-yellow-800 mb-2">âš™ï¸ é…ç½®AI APIï¼ˆå¯é€‰ï¼‰</h3>
        <p class="text-sm text-gray-600">
          è¦ä½¿ç”¨AIè§£æåŠŸèƒ½ï¼Œéœ€è¦åœ¨Renderç¯å¢ƒå˜é‡ä¸­é…ç½®ä»¥ä¸‹ä¹‹ä¸€:
        </p>
        <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1">
          <li><code class="bg-gray-200 px-2 py-1 rounded">ANTHROPIC_API_KEY</code> - Claude AI</li>
          <li><code class="bg-gray-200 px-2 py-1 rounded">GROQ_API_KEY</code> - Groq (å…è´¹)</li>
          <li><code class="bg-gray-200 px-2 py-1 rounded">OPENAI_API_KEY</code> - GPT</li>
        </ul>
        <p class="text-sm text-gray-600 mt-2">
          ğŸ’¡ æ¨èä½¿ç”¨ <strong>Groq</strong> (å…è´¹ä¸”å¿«é€Ÿ): <a href="https://console.groq.com" target="_blank" class="text-blue-600 underline">console.groq.com</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    // ä»localStorageåŠ è½½APIåœ°å€
    window.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem('apiUrl');
      if (savedUrl) {
        document.getElementById('apiUrl').value = savedUrl;
      }
    });

    // æµ‹è¯•APIè¿æ¥
    async function testApi() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·è¾“å…¥APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      localStorage.setItem('apiUrl', apiUrl);
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<p class="text-blue-600">â³ æ­£åœ¨è¿æ¥...</p>';
      try {
        const response = await fetch(`${apiUrl}/api/health`);
        const data = await response.json();
        resultDiv.innerHTML = `
          <div class="text-green-600">
            <p class="font-bold mb-2 text-lg">âœ… APIè¿æ¥æˆåŠŸï¼</p>
            <div class="bg-white p-4 rounded-lg">
              <p class="mb-2"><strong>æœåŠ¡çŠ¶æ€:</strong></p>
              <ul class="list-disc list-inside space-y-1 text-sm">
                <li>é‡‘ä»·API: ${data.services.gold_price === 'ok' ? 'âœ…' : 'âŒ'}</li>
                <li>è‚¡ç¥¨API: ${data.services.stock_price === 'ok' ? 'âœ…' : 'âŒ'}</li>
                <li>AIè§£æ: ${data.services.ai_parser === 'configured' ? 'âœ… å·²é…ç½®' : 'âš ï¸ æœªé…ç½®'}</li>
              </ul>
              ${data.ai_available ? `
                <p class="mt-3 text-sm"><strong>å¯ç”¨AI:</strong></p>
                <ul class="list-disc list-inside text-sm">
                  ${data.ai_available.anthropic ? '<li>âœ… Anthropic Claude</li>' : ''}
                  ${data.ai_available.groq ? '<li>âœ… Groq</li>' : ''}
                  ${data.ai_available.openai ? '<li>âœ… OpenAI</li>' : ''}
                </ul>
              ` : ''}
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="text-red-600">
            <p class="font-bold">âŒ è¿æ¥å¤±è´¥</p>
            <p class="text-sm mt-2">${error.message}</p>
          </div>
        `;
      }
    }

    // è·å–é‡‘ä»·
    async function getGoldPrice() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
        return;
      }
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<p class="text-blue-600">â³ æ­£åœ¨è·å–é‡‘ä»·...</p>';
      try {
        const response = await fetch(`${apiUrl}/api/gold-price`);
        const data = await response.json();
        if (data.success) {
          const prices = data.data;
          resultDiv.innerHTML = `
            <div class="text-green-600">
              <p class="font-bold text-xl mb-3">âœ… 916é‡‘ä»·å·²æ›´æ–°ï¼</p>
              <div class="bg-white p-4 rounded-lg space-y-2">
                <p><span class="font-semibold">é›¶å”®ä»·:</span> RM ${prices.gold_916}/å…‹</p>
                <p><span class="font-semibold">å›æ”¶ä»· (93%):</span> RM ${prices.gold_916_buyback_93}/å…‹</p>
                <p><span class="font-semibold">å›æ”¶ä»· (95%):</span> RM ${prices.gold_916_buyback_95}/å…‹</p>
                <p class="text-sm text-gray-600 mt-3">æ›´æ–°æ—¶é—´: ${prices.last_updated}</p>
                <p class="text-sm text-gray-600">æ•°æ®æ¥æº: ${prices.source}</p>
              </div>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-600"><p>âŒ ${error.message}</p></div>`;
      }
    }

    // ä¸Šä¼ è´¦å•
    async function uploadStatement() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      if (!apiUrl) {
        alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
        return;
      }

      const fileInput = document.getElementById('statementFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
      }

      const resultDiv = document.getElementById('result');
      const uploadBtn = document.getElementById('uploadBtn');
      
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = 'â³ AIåˆ†æä¸­...ï¼ˆå¯èƒ½éœ€è¦10-30ç§’ï¼‰';
      uploadBtn.classList.add('opacity-50', 'cursor-not-allowed');
      
      resultDiv.innerHTML = `
        <div class="text-blue-600 text-center">
          <div class="animate-pulse">
            <p class="text-xl font-bold mb-2">ğŸ¤– AIæ­£åœ¨åˆ†ææ‚¨çš„è´¦å•...</p>
            <p class="text-sm">è¿™å¯èƒ½éœ€è¦10-30ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
          </div>
        </div>
      `;

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${apiUrl}/api/parse-statement-ai`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          displayResults(data);
        } else {
          resultDiv.innerHTML = `
            <div class="text-red-600">
              <p class="font-bold text-lg">âŒ è§£æå¤±è´¥</p>
              <p class="mt-2">${data.error}</p>
              ${data.raw_response ? `
                <details class="mt-3">
                  <summary class="cursor-pointer text-sm">æŸ¥çœ‹AIå“åº”</summary>
                  <pre class="mt-2 text-xs bg-gray-100 p-2 rounded overflow-auto">${data.raw_response}</pre>
                </details>
              ` : ''}
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="text-red-600">
            <p class="font-bold">âŒ ä¸Šä¼ å¤±è´¥</p>
            <p class="text-sm mt-2">${error.message}</p>
          </div>
        `;
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'ğŸš€ å¼€å§‹AIè§£æ';
        uploadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    // æ˜¾ç¤ºè§£æç»“æœ
    function displayResults(data) {
      const resultDiv = document.getElementById('result');
      const parsed = data.data;
      const report = data.report;

      let html = `
        <div class="space-y-4">
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="text-xl font-bold text-green-800 mb-3">âœ… AIè§£ææˆåŠŸï¼</h3>
            
            ${report ? `
              <div class="bg-white rounded-lg p-4 mb-4">
                <h4 class="font-bold text-gray-800 mb-2">ğŸ“Š èµ„äº§æ¦‚è§ˆ</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <div><span class="text-gray-600">æ€»èµ„äº§:</span> <span class="font-bold">RM ${report.summary.total_assets.toFixed(2)}</span></div>
                  <div><span class="text-gray-600">ç°é‡‘ä½™é¢:</span> <span class="font-bold">RM ${report.summary.cash_balance.toFixed(2)}</span></div>
                  <div><span class="text-gray-600">é©¬è‚¡å¸‚å€¼:</span> <span class="font-bold">RM ${report.summary.stock_holdings_my.toFixed(2)}</span></div>
                  <div><span class="text-gray-600">ç¾è‚¡å¸‚å€¼:</span> <span class="font-bold">RM ${report.summary.stock_holdings_us.toFixed(2)}</span></div>
                </div>
              </div>
            ` : ''}
      `;

      // æ˜¾ç¤ºé©¬è‚¡
      if (parsed.stocks_my && parsed.stocks_my.length > 0) {
        html += `
          <div class="bg-white rounded-lg p-4 border">
            <h4 class="font-bold text-gray-800 mb-3">ğŸ‡²ğŸ‡¾ é©¬è‚¡æŒä»“ (${parsed.stocks_my.length})</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-2 text-left">ä»£ç </th>
                    <th class="p-2 text-right">æ•°é‡</th>
                    <th class="p-2 text-right">æˆæœ¬ä»·</th>
                    <th class="p-2 text-right">å¸‚å€¼</th>
                  </tr>
                </thead>
                <tbody>
                  ${parsed.stocks_my.map(stock => `
                    <tr class="border-t">
                      <td class="p-2">${stock.symbol}</td>
                      <td class="p-2 text-right">${stock.shares}</td>
                      <td class="p-2 text-right">RM ${stock.avgPrice.toFixed(2)}</td>
                      <td class="p-2 text-right font-semibold">RM ${(stock.shares * stock.avgPrice).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // æ˜¾ç¤ºç¾è‚¡
      if (parsed.stocks_us && parsed.stocks_us.length > 0) {
        html += `
          <div class="bg-white rounded-lg p-4 border">
            <h4 class="font-bold text-gray-800 mb-3">ğŸ‡ºğŸ‡¸ ç¾è‚¡æŒä»“ (${parsed.stocks_us.length})</h4>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-2 text-left">ä»£ç </th>
                    <th class="p-2 text-right">æ•°é‡</th>
                    <th class="p-2 text-right">æˆæœ¬ä»·</th>
                    <th class="p-2 text-right">å¸‚å€¼</th>
                  </tr>
                </thead>
                <tbody>
                  ${parsed.stocks_us.map(stock => `
                    <tr class="border-t">
                      <td class="p-2">${stock.symbol}</td>
                      <td class="p-2 text-right">${stock.shares}</td>
                      <td class="p-2 text-right">$${stock.avgPrice.toFixed(2)}</td>
                      <td class="p-2 text-right font-semibold">$${(stock.shares * stock.avgPrice).toFixed(2)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      // æ˜¾ç¤ºå…¶ä»–èµ„äº§
      if (parsed.liquid_assets && parsed.liquid_assets.length > 0) {
        html += `
          <div class="bg-white rounded-lg p-4 border">
            <h4 class="font-bold text-gray-800 mb-3">ğŸ’° å¯åŠ¨èµ„äº§ (${parsed.liquid_assets.length})</h4>
            <ul class="space-y-2 text-sm">
              ${parsed.liquid_assets.map(asset => `
                <li class="flex justify-between border-b pb-2">
                  <span>${asset.name}</span>
                  <span class="font-semibold">RM ${asset.value.toFixed(2)}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }

      html += `
          <div class="bg-blue-50 rounded-lg p-4 text-sm">
            <p class="text-gray-600">
              ${data.ai_analysis ? `
                <span class="font-semibold">æå–æ–¹å¼:</span> ${data.ai_analysis.extraction_method}<br>
              ` : ''}
              <span class="font-semibold">è§£ææ—¶é—´:</span> ${new Date(data.timestamp).toLocaleString('zh-CN')}
            </p>
            <p class="text-yellow-700 mt-2">
              âš ï¸ è¯·ä»”ç»†æ ¸å¯¹AIæå–çš„æ•°æ®æ˜¯å¦å‡†ç¡®ï¼
            </p>
          </div>
        </div>
      `;

      resultDiv.innerHTML = html;
    }
  </script>
</body>
</html>
